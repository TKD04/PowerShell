<#
.SYNOPSIS
Adds some required packages to a Vite.
You should install "pnpm" on the your system beforehand,
for example by using the command "corepack enable pnpm".
Otherwise this function wil throw an error.

.PARAMETER UseReact
Whether to support React.

.PARAMETER DeployToGitHubPages
Whether to use GitHub Pages to publish a site.
#>
function Add-MyPackagesToVite {
    [OutputType([void])]
    param (
        [switch]$UseReact,
        [switch]$DeployToGitHubPages
    )

    if (!(Test-MyCommandExists -Command 'pnpm')) {
        throw 'A command "pnpm" was not found. You can install pnpm by using the command "corepack enable pnpm"'
    }

    Initialize-MyGit -UseNode
    git add .
    git commit -m 'Add all the files generated by Vite'

    <# .npmrc #>
    # Add .npmrc for pnpm to be more compatible with npm
    # https://eslint.org/docs/latest/use/getting-started#manual-set-up
    Join-Path -Path $PSScriptRoot -ChildPath 'common\.npmrc' |
    Copy-Item -Destination '.\.npmrc'
    git add '.\.npmrc'
    git commit -m 'Add .npmrc for pnpm to be more compatible with npm'

    # Install npm packages according to package.json generated by Vite
    pnpm i
    git add '.\package.json' '.\pnpm-lock.yaml'
    git commit -m 'Add pnpm as packageManager'

    Install-MyTypeScript -NoEmit -IsVite -UseReact:$UseReact
    Install-MyESLint -IsViteReact:$UseReact
    Install-MyVitest
    Install-MyPrettier -UseTailwindcss
    Install-MyTailwindCss -IsVite
    Install-MyVSCodeSettingsForWeb

    # Add `--open` to `dev` and `preview` npm scirpts
    [hashtable]$package = Import-MyJSON -LiteralPath '.\package.json' -AsHashTable
    $package.scripts['dev'] = 'vite --open'
    $package.scripts['preview'] = 'vite preview --open'
    Export-MyJSON -LiteralPath '.\package.json' -CustomObject $package
    git add '.\package.json'
    git commit -m 'Add `--open` to `dev` and `preview` npm scirpt'

    <# vite.yml #>
    # Add vite.yml to deploy to GitHub Pages
    if ($DeployToGitHubPages) {
        if (Test-MyStrictPath('.\.github\workflows\vite.yml')) {
            throw 'vite.yml is already in place.'
        }

        if (!(Test-MyStrictPath -LiteralPath '.\.github')) {
            New-Item -Path '.\' -Name '.github' -ItemType 'directory'
        }
        if (!(Test-MyStrictPath -LiteralPath '.\.github\workflows')) {
            New-Item -Path '.\.github' -Name 'workflows' -ItemType 'directory'
        }
        Join-Path -Path $PSScriptRoot -ChildPath 'common\vite.yml' |
        Copy-Item -Destination '.\.github\workflows\vite.yml'
        git add '.\.github\workflows\vite.yml'
        git commit -m 'Add vite.yml to deploy to GitHub Pages'
    }
}
